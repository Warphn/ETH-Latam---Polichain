generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String           @id @default(cuid())
  createdAt          DateTime         @default(now())
  baseAccountAddress String           @unique
  subAccountAddress  String?          @unique
  youtubeId          String?          @unique

  // relações “amigáveis” entre usuários (quem inicia vs. quem é alvo)
  initiatedPreferences Preference[]   @relation("InitiatorConnections")
  targetedPreferences  Preference[]   @relation("TargetConnections")

  permissions        SpendPermission[]
  tips               Tip[]

  @@index([baseAccountAddress])
  @@index([subAccountAddress])
}

model Preference {
  id               String  @id @default(cuid())
  userId           String
  userPreferenceId String

  user           User @relation("InitiatorConnections", fields: [userId], references: [id])
  userPreference User @relation("TargetConnections", fields: [userPreferenceId], references: [id])

  @@unique([userId, userPreferenceId])
  @@index([userId])
  @@index([userPreferenceId])
}

model SpendPermission {
  permissionHash String    @id
  createdAt      DateTime  @default(now())
  revokedAt      DateTime?
  userId         String
  ownerAccount   String
  spender        String
  token          String
  allowance      Decimal   @db.Decimal(78, 0) // valores grandes (wei)
  periodSeconds  Int
  startTs        BigInt
  endTs          BigInt
  salt           String
  extraData      Bytes?
  signature      Bytes
  chainId        Int

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ownerAccount])
  @@index([spender])
  @@index([token])
  @@index([chainId])
}

model ServerWallet {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  label     String
  address   String   @unique
  chainId   Int
  active    Boolean  @default(true)

  @@index([label])
  @@index([chainId])
}

model Tip {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  userId        String
  channelId     String
  channelHandle String?
  channelName   String?
  videoId       String
  watchSeconds  Int
  like          Boolean?
  dislike       Boolean?
  subscribed    Boolean?
  payload       Json?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId, videoId])
  @@index([userId])
  @@index([channelId])
  @@index([videoId])
}
