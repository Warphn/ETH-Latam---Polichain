generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                           String            @id @default(cuid())
  createdAt                                    DateTime          @default(now())
  baseAccountAddress                           String            @unique
  subAccountAddress                            String?           @unique
  youtubeId                                    String?           @unique
  Preference_Preference_userIdToUser           Preference[]      @relation("Preference_userIdToUser")
  Preference_Preference_userPreferenceIdToUser Preference[]      @relation("Preference_userPreferenceIdToUser")
  permissions                                  SpendPermission[]
  tips                                         Tip[]

  @@index([baseAccountAddress])
  @@index([subAccountAddress])
}

model SpendPermission {
  permissionHash String    @id
  createdAt      DateTime  @default(now())
  revokedAt      DateTime?
  userId         String
  ownerAccount   String
  spender        String
  token          String
  allowance      Decimal   @db.Decimal(78, 0)
  periodSeconds  Int
  startTs        BigInt
  endTs          BigInt
  salt           String
  extraData      Bytes?
  signature      Bytes
  chainId        Int
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ownerAccount])
  @@index([spender])
  @@index([token])
  @@index([chainId])
}

model ServerWallet {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  label     String
  address   String   @unique
  chainId   Int
  active    Boolean  @default(true)

  @@index([label])
  @@index([chainId])
}

model Preference {
  id                                     String @id
  userId                                 String
  userPreferenceId                       String
  User_Preference_userIdToUser           User   @relation("Preference_userIdToUser", fields: [userId], references: [id])
  User_Preference_userPreferenceIdToUser User   @relation("Preference_userPreferenceIdToUser", fields: [userPreferenceId], references: [id])

  @@unique([userId, userPreferenceId])
  @@index([userId])
  @@index([userPreferenceId])
}

model Tip {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  userId         String
  channelId      String
  channelHandle  String?
  channelName    String?
  videoId        String
  watchSeconds   Int
  like           Boolean?
  dislike        Boolean?
  subscribed     Boolean?
  payload        Json?     // guarda o corpo original para auditoria / debugging

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId, videoId])  // ← idempotência: um tip por user+canal+vídeo
  @@index([userId])
  @@index([channelId])
  @@index([videoId])
}
